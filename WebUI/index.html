<!DOCTYPE html>
<html lang="en_US">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f7fa; }
        .dashboard { padding: 20px; }
        .stats-card { margin-bottom: 20px; }
        .search-bar { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ebeef5; }
        .coord-input { width: 100px; }
        .el-table__body-wrapper {
            max-height: 600px;
            overflow-y: auto;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .pagination-container {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .coord-status {
            background-color: #f0f9ff;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid #409eff;
            margin-bottom: 10px;
        }
        .coord-status span {
            font-weight: bold;
            color: #409eff;
        }
        .dimension-select {
            width: 140px;
        }
        .custom-dimension-input {
            width: 150px;
            margin-left: 10px;
        }
        .export-dialog .el-dialog__body {
            padding: 20px;
        }
        #debug-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 10000;
            padding: 5px 10px;
            background-color: #f56c6c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .language-selector {
            margin-bottom: 20px;
        }
        .lang-flag {
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
    <title>Â§©ÁúºÊèí‰ª∂Web UI</title>
</head>
<body>
<div id="app">
    <!-- Âä†ËΩΩÈÅÆÁΩ© -->
    <div v-if="loading" class="loading-overlay">
        <div style="text-align: center;">
            <el-icon class="is-loading" style="font-size: 40px;"><Loading /></el-icon>
            <div style="margin-top: 10px;">{{ t('Loading...') }} ({{loadingProgress}})</div>
        </div>
    </div>

    <div v-if="!isLoggedIn" class="login-container">
        <el-card style="width: 400px">
            <template #header>
                <h3>{{ t('Tianyan Plugin - Authentication') }}</h3>
                <div class="language-selector">
                    <el-select v-model="currentLanguage" @change="changeLanguage" style="width: 100%">
                        <el-option v-for="lang in availableLanguages" :key="lang.code" :value="lang.code">
                            <span class="lang-flag">{{ lang.flag }}</span>
                            {{ lang.name }}
                        </el-option>
                    </el-select>
                </div>
            </template>
            <el-input v-model="apiBase" :placeholder="t('Please enter backend IP and port')" style="margin-bottom: 15px;" @keyup.enter="login"></el-input>
            <el-input v-model="secret" :placeholder="t('Please enter WebUI Secret')" show-password @keyup.enter="login"></el-input>
            <el-button type="primary" style="width: 100%; margin-top: 20px" @click="login">{{ t('Enter Console') }}</el-button>
        </el-card>
    </div>

    <div v-else class="dashboard">
        <el-page-header @back="logout" :content="t('Tianyan Record Monitor Panel')">
            <template #content>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>{{ t('Tianyan Record Monitor Panel') }}</span>
                    <el-select v-model="currentLanguage" @change="changeLanguage" size="small" style="width: 120px; margin-left: 20px;">
                        <el-option v-for="lang in availableLanguages" :key="lang.code" :value="lang.code">
                            <span class="lang-flag">{{ lang.flag }}</span>
                            {{ lang.name }}
                        </el-option>
                    </el-select>
                </div>
            </template>
        </el-page-header>

        <el-row :gutter="20" class="stats-card">
            <el-col :span="6">
                <el-statistic :title="t('Total Logs')" :value="stats.total_logs" />
            </el-col>
            <el-col :span="6">
                <el-statistic :title="t('Database Size')" :value="stats.db_size" />
            </el-col>
            <el-col :span="6">
                <el-statistic :title="t('Query Time')" :value="lastQueryTime ? lastQueryTime + 'ms' : '--'" />
            </el-col>
            <el-col :span="6">
                <el-button
                    @click="fetchStats"
                    icon="Refresh"
                    :loading="statsLoading"
                    >
                    {{ statsLoading ? t('Refreshing...') : t('Refresh Status') }}
                </el-button>
                <el-button @click="showDbInfo" icon="InfoFilled">{{ t('Database Info') }}</el-button>
                <el-button v-if="isDebugMode" @click="debugCheckData" type="warning" size="small">{{ t('Debug') }}</el-button>
            </el-col>
        </el-row>

        <div class="search-bar">
            <!-- ÂùêÊ†áÁä∂ÊÄÅÊòæÁ§∫ -->
            <div v-if="hasActiveCoordQuery" class="coord-status">
                <span>{{ t('Current query conditions') }}:</span>
                X={{queryForm.center_x}}, Y={{queryForm.center_y}}, Z={{queryForm.center_z}}, {{ t('Radius') }}={{queryForm.radius}}{{ t('blocks') }}
                <span v-if="queryForm.dimension && queryForm.dimension !== 'all'">, {{ t('World/Dimension') }}={{queryForm.dimension}}</span>
            </div>

            <el-form :inline="true" :model="queryForm">
                <el-form-item :label="t('Items per page')">
                    <el-input-number v-model="pagination.page_size" :min="10" :max="500" :step="10" @change="handlePageSizeChange" />
                </el-form-item>
                <el-form-item :label="t('Time Range')">
                    <el-date-picker
                        v-model="queryForm.timeRange"
                        type="datetimerange"
                        :range-separator="t('to')"
                        :start-placeholder="t('Start')"
                        :end-placeholder="t('End')"
                        value-format="x"
                        :disabled="loading">
                    </el-date-picker>
                </el-form-item>
                <el-form-item :label="t('Keyword Filter')">
                    <el-select v-model="queryForm.filterType" :placeholder="t('Select field')" style="width: 150px" clearable :disabled="loading">
                        <el-option :label="t('Source ID')" value="id"></el-option>
                        <el-option :label="t('Source Name')" value="name"></el-option>
                        <el-option :label="t('Action Type')" value="type"></el-option>
                        <el-option :label="t('Target ID')" value="obj_id"></el-option>
                        <el-option :label="t('Target Name')" value="obj_name"></el-option>
                        <el-option :label="t('World/Dimension')" value="world"></el-option>
                        <el-option :label="t('Detailed Info')" value="data"></el-option>
                    </el-select>
                    <el-input v-model="queryForm.filterValue" :placeholder="t('Keyword (fuzzy matching)')" style="width: 180px; margin-left: 10px" :disabled="loading"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="fetchLogs(1)" :disabled="loading">{{ t('Query Data') }}</el-button>
                    <el-button @click="resetSearch" :disabled="loading">{{ t('Reset Conditions') }}</el-button>
                    <el-button @click="showExportDialog" :disabled="loading || !hasQueryResults">{{ t('Export CSV') }}</el-button>
                </el-form-item>
            </el-form>

            <el-divider></el-divider>

            <el-form :inline="true" :model="tempCoord">
                <el-form-item :label="t('Coordinate Query')">
                    <el-input v-model="tempCoord.center_x" placeholder="X" class="coord-input" :disabled="loading"></el-input>
                    <el-input v-model="tempCoord.center_y" placeholder="Y" class="coord-input" :disabled="loading"></el-input>
                    <el-input v-model="tempCoord.center_z" placeholder="Z" class="coord-input" :disabled="loading"></el-input>
                    <span style="margin: 0 10px;">{{ t('Radius') }}:</span>
                    <el-input-number v-model="tempCoord.radius" :min="0" :step="1" :precision="1" :placeholder="t('Radius')" :disabled="loading"></el-input-number>

                    <el-select
                        v-model="tempCoord.dimension"
                        :placeholder="t('Select Dimension')"
                        class="dimension-select"
                        :disabled="loading"
                        style="margin-left: 10px;"
                    >
                        <el-option :label="t('All (all dimensions)')" value="all"></el-option>
                        <el-option :label="t('Overworld')" value="Overworld"></el-option>
                        <el-option :label="t('Nether')" value="Nether"></el-option>
                        <el-option :label="t('TheEnd')" value="TheEnd"></el-option>
                        <el-option :label="t('Custom Dimension')" value="custom"></el-option>
                    </el-select>

                    <el-input
                        v-if="tempCoord.dimension === 'custom'"
                        v-model="tempCoord.customDimension"
                        :placeholder="t('Enter dimension name')"
                        class="custom-dimension-input"
                        :disabled="loading"
                    ></el-input>

                    <el-button type="success" @click="applyCoordQuery" style="margin-left: 10px;" :disabled="loading">{{ t('Apply Coordinates') }}</el-button>
                    <el-button @click="clearCoordQuery" :disabled="loading || !hasActiveCoordQuery">{{ t('Clear Coordinates') }}</el-button>
                </el-form-item>
            </el-form>
        </div>

        <div v-if="hasQueryResults" class="pagination-container">
            <div>
                <span>{{ pagination.total }} {{ t('records found, total') }} {{pagination.total_pages}} {{ t('pages') }}</span>
                <span v-if="pagination.total > 0">Ôºå{{ t('Currently showing') }} {{(pagination.page - 1) * pagination.page_size + 1}}-{{Math.min(pagination.page * pagination.page_size, pagination.total)}} {{ t('records') }}</span>
            </div>
        </div>

        <div v-else-if="!hasQueryResults && logs.length === 0" style="text-align: center; padding: 40px; color: #999;">
            <el-icon size="40"><Search /></el-icon>
            <div style="margin-top: 10px;">{{ t('Please enter search conditions and click') }} "{{ t('Query Data') }}" {{ t('button') }}</div>
            <div style="margin-top: 5px; font-size: 14px;">{{ t('Or use coordinate query for specific area') }}</div>
        </div>

        <!-- Êü•ËØ¢Ëøá‰ΩÜÊ≤°ÊúâÁªìÊûúÁöÑÊèêÁ§∫ -->
        <div v-else-if="hasQueryResults && logs.length === 0" style="text-align: center; padding: 40px; color: #999;">
            <el-icon size="40"><Search /></el-icon>
            <div style="margin-top: 10px;">{{ t('No matching records found') }}</div>
        </div>

        <!-- ‰ΩøÁî®‰∏Ä‰∏™Ë°®Ê†ºÔºåÂä®ÊÄÅÊòæÁ§∫Ë∑ùÁ¶ªÂàó -->
        <el-table
            v-if="hasQueryResults && logs.length > 0"
            :data="logs"
            border
            stripe
            style="width: 100%"
            height="600"
            v-loading="tableLoading"
            :row-key="getRowKey"
            :default-sort="{prop: 'time', order: 'descending'}"
            :key="tableKey"
        >
            <el-table-column :label="t('Time')" width="180" sortable prop="time">
                <template #default="scope">
                    {{ new Date(scope.row.time * 1000).toLocaleString() }}
                </template>
            </el-table-column>
            <el-table-column prop="id" :label="t('Source ID')" width="200"></el-table-column>
            <el-table-column prop="name" :label="t('Source Name')" width="180"></el-table-column>
            <el-table-column prop="type" :label="t('Action Type')" width="200"></el-table-column>
            <el-table-column prop="obj_id" :label="t('Target ID')" width="200"></el-table-column>
            <el-table-column prop="obj_name" :label="t('Target Name')" width="180"></el-table-column>
            <el-table-column :label="t('Position')" width="240">
                <template #default="scope">
                    {{scope.row.pos_x.toFixed(1)}}, {{scope.row.pos_y.toFixed(1)}}, {{scope.row.pos_z.toFixed(1)}} ({{scope.row.world}})
                </template>
            </el-table-column>
            <!-- Âä®ÊÄÅÊòæÁ§∫Ë∑ùÁ¶ªÂàó -->
            <el-table-column v-if="showDistanceColumn" :label="t('Distance')" width="80">
                <template #default="scope">
                    {{scope.row.distance ? scope.row.distance + t('blocks') : '-'}}
                </template>
            </el-table-column>
            <el-table-column prop="data" :label="t('Detailed Data')" min-width="300"></el-table-column>
        </el-table>

        <div v-if="hasQueryResults && logs.length > 0" class="pagination-container" style="margin-top: 20px;">
            <div></div> <!-- Âç†‰Ωç -->
            <el-pagination
                v-model:current-page="pagination.page"
                v-model:page-size="pagination.page_size"
                :page-sizes="[50, 100, 200, 500]"
                :small="true"
                :background="true"
                layout="sizes, prev, pager, next, jumper, ->, total"
                :total="pagination.total"
                @size-change="handlePageSizeChange"
                @current-change="handlePageChange"
                :disabled="loading"
            />
        </div>
    </div>

    <!-- ÂØºÂá∫ÂØπËØùÊ°Ü -->
    <el-dialog
        v-model="exportDialogVisible"
        :title="t('Export Data to CSV')"
        width="500px"
        class="export-dialog"
    >
        <div style="margin-bottom: 15px;">
            <strong>{{ t('Export Options') }}</strong>
        </div>
        <div style="margin-bottom: 10px;">
            <el-radio v-model="exportOption" label="current">{{ t('Export current page') }} ({{pagination.page_size}}{{ t('records') }})</el-radio>
        </div>
        <div style="margin-bottom: 10px;">
            <el-radio v-model="exportOption" label="range">{{ t('Export specified page range') }}</el-radio>
            <div v-if="exportOption === 'range'" style="margin-top: 10px; margin-left: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <div>{{ t('From page') }}</div>
                    <el-input-number v-model="exportStartPage" :min="1" :max="pagination.total_pages" size="small" style="width: 100px;"></el-input-number>
                    <div>{{ t('to page') }}</div>
                    <el-input-number v-model="exportEndPage" :min="1" :max="pagination.total_pages" size="small" style="width: 100px;"></el-input-number>
                    <div>({{ t('of total') }} {{pagination.total_pages}} {{ t('pages (total)') }})</div>
                </div>
                <div style="margin-top: 5px; color: #666; font-size: 12px;">
                    {{ t('Max export data') }}: 50000 {{ t('records') }}, {{ t('approximately') }} {{Math.min(pagination.total_pages, Math.floor(50000/pagination.page_size))}} {{ t('pages') }}
                </div>
            </div>
        </div>
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <div style="color: #666; font-size: 13px;">
                {{ t('Note: Exporting large amounts of data may take time, please be patient') }}
            </div>
        </div>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="exportDialogVisible = false">{{ t('Cancel') }}</el-button>
                <el-button type="primary" @click="handleExportConfirm" :disabled="exporting">
                    {{ exporting ? t('Exporting...') : t('Start Export') }}
                </el-button>
            </span>
        </template>
    </el-dialog>
</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    // ËØ≠Ë®ÄÈÖçÁΩÆ
    const languageConfig = {
        'en_US': { name: 'English', flag: 'üá∫üá∏' },
        'zh_CN': { name: '‰∏≠Êñá', flag: 'üá®üá≥' },
        'ru_RU': { name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' }
    };

    createApp({
        setup() {
            const isLoggedIn = ref(false);
            const secret = ref(localStorage.getItem('ty_secret') || '');
            const apiBase = ref(localStorage.getItem('ty_api_base') || 'http://127.0.0.1:8098');
            const stats = reactive({ total_logs: 0, db_size: '0 MB' });
            const logs = ref([]);
            const loading = ref(false);
            const tableLoading = ref(false);
            const loadingProgress = ref('');
            const lastQueryTime = ref(0);
            const hasQueryResults = ref(false);
            const statsLoading = ref(false);
            const isQuerying = ref(false);

            // Â§öËØ≠Ë®ÄÁõ∏ÂÖ≥
            const currentLanguage = ref(localStorage.getItem('ty_language') || 'en_US');
            const availableLanguages = ref([]);
            const translations = ref({});

            // ÂØºÂá∫Áõ∏ÂÖ≥Áä∂ÊÄÅ
            const exportDialogVisible = ref(false);
            const exportOption = ref('current');
            const exportStartPage = ref(1);
            const exportEndPage = ref(1);
            const exporting = ref(false);

            // ÊéßÂà∂ÊòØÂê¶ÊòæÁ§∫Ë∑ùÁ¶ªÂàó
            const showDistanceColumn = ref(false);

            // Ë°®Ê†ºÁâàÊú¨Âè∑ÔºåÁî®‰∫éÂº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
            const tableVersion = ref(0);

            // Ë∞ÉËØïÊ®°Âºè
            const isDebugMode = ref(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');

            const queryForm = reactive({
                timeRange: [Date.now() - 7200000, Date.now()], // ÈªòËÆ§ÊúÄËøë2Â∞èÊó∂
                filterType: '',
                filterValue: '',
                center_x: null,
                center_y: null,
                center_z: null,
                radius: null,
                dimension: null
            });

            const tempCoord = reactive({
                center_x: '',
                center_y: '',
                center_z: '',
                radius: 10,
                dimension: 'all',
                customDimension: ''
            });

            const pagination = reactive({
                page: 1,
                page_size: 100,
                total: 0,
                total_pages: 1
            });

            const API_BASE = computed(() => {
                return `${apiBase.value}/api`;
            });

            // ËÆ°ÁÆóÂ±ûÊÄß
            const hasActiveCoordQuery = computed(() => {
                return (queryForm.center_x !== null && queryForm.center_y !== null &&
                       queryForm.center_z !== null && queryForm.radius !== null) ||
                       (queryForm.dimension !== null && queryForm.dimension !== 'all');
            });

            // Ë°®Ê†ºkeyÔºåÂº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
            const tableKey = computed(() => {
                return `table-${tableVersion.value}`;
            });

            // ÁøªËØëÂáΩÊï∞
            const t = (key) => {
                return translations.value[key] || key;
            };

            // Âä†ËΩΩÂèØÁî®ËØ≠Ë®Ä
            const loadAvailableLanguages = async () => {
                try {
                    const res = await axios.get(`${API_BASE.value}/languages`);
                    const languages = res.data.languages || [];

                    availableLanguages.value = languages.map(code => ({
                        code,
                        name: languageConfig[code]?.name || code,
                        flag: languageConfig[code]?.flag || 'üåê'
                    }));

                    // Â¶ÇÊûúÂΩìÂâçËØ≠Ë®Ä‰∏çÂú®ÂèØÁî®ËØ≠Ë®Ä‰∏≠Ôºå‰ΩøÁî®ÈªòËÆ§ËØ≠Ë®Ä
                    if (!languages.includes(currentLanguage.value)) {
                        currentLanguage.value = res.data.default || 'en_US';
                    }

                    await loadLanguage(currentLanguage.value);
                } catch (error) {
                    console.error('Failed to load languages:', error);
                    // ÈªòËÆ§Âä†ËΩΩËã±Êñá
                    await loadLanguage('en_US');
                }
            };

            // Âä†ËΩΩËØ≠Ë®ÄÊñá‰ª∂
            const loadLanguage = async (langCode) => {
                try {
                    loading.value = true;
                    loadingProgress.value = t('Loading language...');

                    const res = await axios.get(`${API_BASE.value}/language/${langCode}`);
                    translations.value = res.data;
                    currentLanguage.value = langCode;
                    localStorage.setItem('ty_language', langCode);

                    // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
                    document.title = t('Tianyan Plugin Web UI');

                    console.log(`Loaded language: ${langCode}`);
                } catch (error) {
                    console.error(`Failed to load language ${langCode}:`, error);
                    ElementPlus.ElMessage.error(`Failed to load language: ${langCode}`);
                } finally {
                    loading.value = false;
                }
            };

            // ÂàáÊç¢ËØ≠Ë®Ä
            const changeLanguage = async (langCode) => {
                await loadLanguage(langCode);
                ElementPlus.ElMessage.success(`Language changed to ${languageConfig[langCode]?.name || langCode}`);
            };

            // ÁõëÂê¨ÂØºÂá∫È°µÁ†ÅÂèòÂåñ
            watch(() => exportStartPage.value, (newVal) => {
                if (exportEndPage.value < newVal) {
                    exportEndPage.value = newVal;
                }
                const maxPages = Math.min(pagination.total_pages, Math.floor(50000/pagination.page_size));
                if (exportEndPage.value > maxPages) {
                    exportEndPage.value = maxPages;
                }
            });

            watch(() => pagination.total_pages, (newVal) => {
                exportEndPage.value = Math.min(newVal, Math.floor(50000/pagination.page_size));
            });

            const login = async () => {
                try {
                    loading.value = true;
                    loadingProgress.value = t('Verifying...');
                    const res = await axios.get(`${API_BASE.value}/stats`, {
                        headers: {
                            'X-Secret': secret.value,
                            'X-Lang': currentLanguage.value
                        }
                    });
                    isLoggedIn.value = true;
                    localStorage.setItem('ty_secret', secret.value);
                    localStorage.setItem('ty_api_base', apiBase.value);
                    Object.assign(stats, res.data);
                    ElementPlus.ElMessage.success(t('Login successful'));

                    // ÈáçÊñ∞Âä†ËΩΩËØ≠Ë®ÄÂàóË°®‰ª•Á°Æ‰øùÊñ∞ÂêéÁ´ØÂú∞ÂùÄÁöÑËØ≠Ë®ÄÊîØÊåÅÂæóÂà∞Êõ¥Êñ∞
                    await loadAvailableLanguages();
                    
                    // ÂÖ≥ÈîÆÔºöÁôªÂΩïÊàêÂäüÂêéÂÆåÂÖ®ÈáçÁΩÆÊü•ËØ¢Êù°‰ª∂
                    resetSearch();

                    console.log('Login successful, query conditions reset');
                } catch (e) {
                    ElementPlus.ElMessage.error(t('Authentication failed, please check Secret'));
                } finally {
                    loading.value = false;
                }
            };

            const logout = () => {
                isLoggedIn.value = false;
                localStorage.removeItem('ty_secret');
                ElementPlus.ElMessage.success(t('Logged out'));
            };

            const fetchStats = async () => {
                statsLoading.value = true;
                try {
                    const res = await axios.get(`${API_BASE.value}/stats`, {
                        headers: {
                            'X-Secret': secret.value,
                            'X-Lang': currentLanguage.value
                        }
                    });
                    Object.assign(stats, res.data);
                    ElementPlus.ElMessage.success(t('Status refreshed successfully'));
                } catch (e) {
                    ElementPlus.ElMessage.error(t('Failed to get status') + ': ' + (e.response?.data?.detail || e.message));
                } finally {
                    statsLoading.value = false;
                }
            };

            const fetchLogs = async (page = null) => {
                // Èò≤Ê≠¢Âπ∂ÂèëÊü•ËØ¢
                if (isQuerying.value) {
                    console.log('Query in progress, skipping this request');
                    return;
                }

                isQuerying.value = true;

                try {
                    if (page !== null) {
                        pagination.page = page;
                    }

                    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂú®ÊØèÊ¨°Êü•ËØ¢ÂâçÂÆåÂÖ®Ê∏ÖÁ©∫ÊóßÊï∞ÊçÆ
                    logs.value = [];
                    hasQueryResults.value = false;
                    showDistanceColumn.value = false;

                    // Âº∫Âà∂VueÊõ¥Êñ∞DOM
                    await nextTick();

                    console.log('Starting new query, old data cleared');

                    const params = {
                        page: pagination.page,
                        page_size: pagination.page_size,
                        start_time: queryForm.timeRange ? Math.floor(queryForm.timeRange[0] / 1000) : null,
                        end_time: queryForm.timeRange ? Math.floor(queryForm.timeRange[1] / 1000) : null,
                        filter_type: queryForm.filterType,
                        filter_value: queryForm.filterValue
                    };

                    // Â¶ÇÊûúÊúâÂùêÊ†áÊü•ËØ¢Êù°‰ª∂
                    if (queryForm.center_x !== null && queryForm.center_y !== null &&
                        queryForm.center_z !== null && queryForm.radius !== null) {
                        params.center_x = queryForm.center_x;
                        params.center_y = queryForm.center_y;
                        params.center_z = queryForm.center_z;
                        params.radius = queryForm.radius;
                        showDistanceColumn.value = true;
                    }

                    // Â¶ÇÊûúÊúâÁª¥Â∫¶Êù°‰ª∂
                    if (queryForm.dimension !== null && queryForm.dimension !== 'all' && queryForm.dimension !== '') {
                        params.dimension = queryForm.dimension;
                    }

                    console.log('Request parameters:', params);

                    tableLoading.value = true;
                    loadingProgress.value = t('Querying data...');

                    const startTime = Date.now();
                    const res = await axios.get(`${API_BASE.value}/logs`, {
                        headers: {
                            'X-Secret': secret.value,
                            'X-Lang': currentLanguage.value
                        },
                        params: params,
                        timeout: 30000
                    });

                    const endTime = Date.now();
                    const duration = endTime - startTime;

                    if (res.data && res.data.data) {
                        console.log('Data returned:', res.data.data.length);

                        // ÂàõÂª∫ÂÖ®Êñ∞ÁöÑÊï∞ÁªÑ
                        const processedData = [];

                        for (const record of res.data.data) {
                            const newRecord = {
                                time: record.time || 0,
                                id: record.id || '',
                                name: record.name || '',
                                type: record.type || '',
                                obj_id: record.obj_id || '',
                                obj_name: record.obj_name || '',
                                pos_x: record.pos_x || 0,
                                pos_y: record.pos_y || 0,
                                pos_z: record.pos_z || 0,
                                world: record.world || '',
                                data: record.data || ''
                            };

                            if (params.center_x !== undefined &&
                                params.center_y !== undefined &&
                                params.center_z !== undefined) {
                                const dx = newRecord.pos_x - params.center_x;
                                const dy = newRecord.pos_y - params.center_y;
                                const dz = newRecord.pos_z - params.center_z;
                                newRecord.distance = Math.sqrt(dx*dx + dy*dy + dz*dz).toFixed(2);
                            }

                            processedData.push(newRecord);
                        }

                        // È™åËØÅÊï∞ÊçÆÊòØÂê¶Á¨¶ÂêàÊü•ËØ¢Êù°‰ª∂
                        if (queryForm.filterType && queryForm.filterValue) {
                            const invalidRecords = processedData.filter(record => {
                                const fieldValue = record[queryForm.filterType];
                                return !fieldValue || !fieldValue.includes(queryForm.filterValue);
                            });

                            if (invalidRecords.length > 0) {
                                console.error(`Found ${invalidRecords.length} records that do not match query conditions`);
                                console.error('Query conditions:', queryForm.filterType, '=', queryForm.filterValue);
                                console.error('Invalid record example:', invalidRecords[0]);
                            }
                        }

                        // Êõ¥Êñ∞Êï∞ÊçÆ
                        logs.value = processedData;
                        pagination.total = res.data.total || 0;
                        pagination.total_pages = res.data.total_pages || 1;
                        lastQueryTime.value = res.data.query_time_ms || Math.round(duration);

                        // Â¢ûÂä†Ë°®Ê†ºÁâàÊú¨Âè∑ÔºåÂº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
                        tableVersion.value++;

                        if (logs.value.length > 0) {
                            hasQueryResults.value = true;
                            console.log(`Query successful, displaying ${logs.value.length} records`);
                            ElementPlus.ElMessage.success(
                                `${t('Query successful! Retrieved')} ${logs.value.length} ${t('records, query time')}: ${lastQueryTime.value}${t('ms')}`
                            );
                        } else {
                            hasQueryResults.value = false;
                            console.log('Query successful but no matching records found');
                            ElementPlus.ElMessage.info(t('No matching records found'));
                        }
                    } else {
                        console.error('Return data format error');
                        ElementPlus.ElMessage.error(t('Return data format error'));
                        logs.value = [];
                        hasQueryResults.value = false;
                    }
                } catch (e) {
                    console.error('Query error:', e);
                    if (e.code === 'ECONNABORTED') {
                        ElementPlus.ElMessage.error(t('Query timeout, please reduce query size or optimize conditions'));
                    } else {
                        ElementPlus.ElMessage.error(t('Query error') + ': ' + (e.response?.data?.detail || e.message));
                    }
                    logs.value = [];
                    hasQueryResults.value = false;
                } finally {
                    tableLoading.value = false;
                    loading.value = false;
                    isQuerying.value = false;
                }
            };

            // Áªü‰∏ÄÁöÑrow-keyÁîüÊàêÊñπÊ≥ï
            const getRowKey = (row) => {
                return `${row.time}-${row.id}-${row.type}-${row.pos_x}-${row.pos_y}-${row.pos_z}`;
            };

            const applyCoordQuery = () => {
                // È™åËØÅÂùêÊ†áËæìÂÖ•
                if (!tempCoord.center_x || !tempCoord.center_y || !tempCoord.center_z) {
                    ElementPlus.ElMessage.warning(t('Invalid coordinate parameters'));
                    return;
                }
                if (!tempCoord.radius || tempCoord.radius <= 0) {
                    ElementPlus.ElMessage.warning(t('Please enter valid radius'));
                    return;
                }

                // Â∞Ü‰∏¥Êó∂ÂùêÊ†áÂ∫îÁî®Âà∞Êü•ËØ¢Ë°®Âçï
                queryForm.center_x = parseFloat(tempCoord.center_x);
                queryForm.center_y = parseFloat(tempCoord.center_y);
                queryForm.center_z = parseFloat(tempCoord.center_z);
                queryForm.radius = parseFloat(tempCoord.radius);

                // Â§ÑÁêÜÁª¥Â∫¶
                if (tempCoord.dimension === 'custom' && tempCoord.customDimension) {
                    queryForm.dimension = tempCoord.customDimension;
                } else if (tempCoord.dimension === 'all') {
                    queryForm.dimension = null; // ÂÖ®ÈÉ®Áª¥Â∫¶
                } else {
                    queryForm.dimension = tempCoord.dimension;
                }

                ElementPlus.ElMessage.success(t('Coordinate query conditions applied'));
                fetchLogs(1);
            };

            const clearCoordQuery = () => {
                queryForm.center_x = null;
                queryForm.center_y = null;
                queryForm.center_z = null;
                queryForm.radius = null;
                queryForm.dimension = null;

                // Ê∏ÖÁ©∫‰∏¥Êó∂ÂùêÊ†á
                tempCoord.center_x = '';
                tempCoord.center_y = '';
                tempCoord.center_z = '';
                tempCoord.radius = 10;
                tempCoord.dimension = 'all';
                tempCoord.customDimension = '';

                ElementPlus.ElMessage.info(t('Coordinate query conditions cleared'));
                fetchLogs(1);
            };

            const resetSearch = () => {
                queryForm.timeRange = [Date.now() - 7200000, Date.now()];
                queryForm.filterType = '';
                queryForm.filterValue = '';
                queryForm.center_x = null;
                queryForm.center_y = null;
                queryForm.center_z = null;
                queryForm.radius = null;
                queryForm.dimension = null;

                tempCoord.center_x = '';
                tempCoord.center_y = '';
                tempCoord.center_z = '';
                tempCoord.radius = 10;
                tempCoord.dimension = 'all';
                tempCoord.customDimension = '';

                pagination.page = 1;
                pagination.total = 0;
                pagination.total_pages = 1;

                // Âº∫Âà∂Ê∏ÖÁ©∫Êï∞ÊçÆ
                logs.value = [];
                hasQueryResults.value = false;
                lastQueryTime.value = 0;
                showDistanceColumn.value = false;

                // Â¢ûÂä†Ë°®Ê†ºÁâàÊú¨Âè∑
                tableVersion.value++;

                // Âº∫Âà∂DOMÊõ¥Êñ∞
                nextTick(() => {
                    console.log('Reset query conditions completed, data cleared');
                });

                ElementPlus.ElMessage.info(t('All search conditions reset'));
            };

            const handlePageChange = (page) => {
                fetchLogs(page);
            };

            const handlePageSizeChange = (size) => {
                pagination.page_size = size;
                pagination.page = 1;
                fetchLogs(1);
            };

            const showExportDialog = () => {
                if (!hasQueryResults.value || pagination.total_pages === 0) {
                    ElementPlus.ElMessage.warning(t('No data to export'));
                    return;
                }

                exportStartPage.value = 1;
                exportEndPage.value = Math.min(pagination.total_pages, Math.floor(50000/pagination.page_size));
                exportOption.value = 'current';
                exportDialogVisible.value = true;
            };

            const handleExportConfirm = () => {
                if (exportOption.value === 'current') {
                    exportCurrentPage();
                } else if (exportOption.value === 'range') {
                    if (exportStartPage.value > exportEndPage.value) {
                        ElementPlus.ElMessage.error(t('Start page cannot be greater than end page'));
                        return;
                    }

                    const totalExportPages = exportEndPage.value - exportStartPage.value + 1;
                    const estimatedRecords = totalExportPages * pagination.page_size;

                    if (estimatedRecords > 50000) {
                        ElementPlus.ElMessage.error(t('Export data too large, max 50000 records, currently about') + ` ${estimatedRecords} ` + t('records'));
                        return;
                    }

                    ElementPlus.ElMessageBox.confirm(
                        `${t('Confirm export from page')} ${exportStartPage.value} ${t('to page')} ${exportEndPage.value}?` +
                        `\n${t('Total')} ${totalExportPages} ${t('pages')}, ${t('approximately')} ${estimatedRecords} ${t('records')}.`,
                        t('Confirm export'),
                        {
                            confirmButtonText: t('Confirm'),
                            cancelButtonText: t('Cancel'),
                            type: 'warning'
                        }
                    ).then(() => {
                        exportPages(exportStartPage.value, exportEndPage.value);
                    }).catch(() => {
                        // Áî®Êà∑ÂèñÊ∂à
                    });
                }

                exportDialogVisible.value = false;
            };

            const exportCurrentPage = () => {
                try {
                    exporting.value = true;

                    // ÂàõÂª∫CSVÂÜÖÂÆπ
                    const headers = [
                        t('Time'),
                        t('Source ID'),
                        t('Source Name'),
                        t('Action Type'),
                        t('Target ID'),
                        t('Target Name'),
                        t('Coordinate X'),
                        t('Coordinate Y'),
                        t('Coordinate Z'),
                        t('World/Dimension')
                    ];
                    if (showDistanceColumn.value) {
                        headers.push(t('Distance'));
                    }
                    headers.push(t('Detailed Data'));

                    const csvRows = [];

                    // Ê∑ªÂä†Ë°®Â§¥
                    csvRows.push(headers.join(','));

                    // Ê∑ªÂä†Êï∞ÊçÆË°å
                    logs.value.forEach(row => {
                        const csvRow = [
                            new Date(row.time * 1000).toLocaleString(),
                            `"${row.id || ''}"`,
                            `"${row.name || ''}"`,
                            `"${row.type || ''}"`,
                            `"${row.obj_id || ''}"`,
                            `"${row.obj_name || ''}"`,
                            row.pos_x,
                            row.pos_y,
                            row.pos_z,
                            `"${row.world || ''}"`
                        ];

                        if (showDistanceColumn.value && row.distance !== undefined) {
                            csvRow.push(row.distance || '');
                        }

                        csvRow.push(`"${(row.data || '').replace(/"/g, '""')}"`); // Â§ÑÁêÜÂºïÂè∑ËΩ¨‰πâ
                        csvRows.push(csvRow.join(','));
                    });

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `tianyan_${pagination.page}_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    ElementPlus.ElMessage.success(`${t('Exported')} ${logs.value.length} ${t('records')}`);
                } catch (error) {
                    ElementPlus.ElMessage.error(t('Export failed') + ': ' + error.message);
                } finally {
                    exporting.value = false;
                }
            };

            const exportPages = async (startPage, endPage) => {
                try {
                    exporting.value = true;
                    loading.value = true;
                    loadingProgress.value = `${t('Preparing to export from page')} ${startPage} ${t('to')} ${endPage}...`;

                    // ÊûÑÂª∫ÂØºÂá∫ÂèÇÊï∞
                    const params = {
                        start_page: startPage,
                        end_page: endPage,
                        page_size: pagination.page_size,
                        start_time: queryForm.timeRange ? Math.floor(queryForm.timeRange[0] / 1000) : null,
                        end_time: queryForm.timeRange ? Math.floor(queryForm.timeRange[1] / 1000) : null,
                        filter_type: queryForm.filterType,
                        filter_value: queryForm.filterValue
                    };

                    // Â¶ÇÊûúÊúâÂùêÊ†áÊü•ËØ¢Êù°‰ª∂
                    if (queryForm.center_x !== null && queryForm.center_y !== null &&
                        queryForm.center_z !== null && queryForm.radius !== null) {
                        params.center_x = queryForm.center_x;
                        params.center_y = queryForm.center_y;
                        params.center_z = queryForm.center_z;
                        params.radius = queryForm.radius;
                    }

                    // Â¶ÇÊûúÊúâÁª¥Â∫¶Êù°‰ª∂
                    if (queryForm.dimension !== null && queryForm.dimension !== 'all' && queryForm.dimension !== '') {
                        params.dimension = queryForm.dimension;
                    }

                    loadingProgress.value = t('Getting data from server...');

                    const res = await axios.get(`${API_BASE.value}/export`, {
                        headers: {
                            'X-Secret': secret.value,
                            'X-Lang': currentLanguage.value
                        },
                        params: params,
                        timeout: 120000 // 120ÁßíË∂ÖÊó∂
                    });

                    if (res.data && res.data.data) {
                        const exportData = res.data.data;

                        loadingProgress.value = t('Generating CSV file...');

                        // ÂàõÂª∫CSVÂÜÖÂÆπ
                        const headers = [
                            t('Time'),
                            t('Source ID'),
                            t('Source Name'),
                            t('Action Type'),
                            t('Target ID'),
                            t('Target Name'),
                            t('Coordinate X'),
                            t('Coordinate Y'),
                            t('Coordinate Z'),
                            t('World/Dimension')
                        ];
                        if (showDistanceColumn.value) {
                            headers.push(t('Distance'));
                        }
                        headers.push(t('Detailed Data'));

                        const csvRows = [];

                        // Ê∑ªÂä†Ë°®Â§¥
                        csvRows.push(headers.join(','));

                        // Ê∑ªÂä†Êï∞ÊçÆË°å
                        exportData.forEach(row => {
                            const csvRow = [
                                new Date(row.time * 1000).toLocaleString(),
                                `"${row.id || ''}"`,
                                `"${row.name || ''}"`,
                                `"${row.type || ''}"`,
                                `"${row.obj_id || ''}"`,
                                `"${row.obj_name || ''}"`,
                                row.pos_x,
                                row.pos_y,
                                row.pos_z,
                                `"${row.world || ''}"`
                            ];

                            if (showDistanceColumn.value && row.distance !== undefined) {
                                csvRow.push(row.distance || '');
                            }

                            csvRow.push(`"${(row.data || '').replace(/"/g, '""')}"`); // Â§ÑÁêÜÂºïÂè∑ËΩ¨‰πâ
                            csvRows.push(csvRow.join(','));
                        });

                        const csvContent = csvRows.join('\n');
                        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `tianyan_${startPage}_${endPage}_${new Date().toISOString().slice(0, 10)}.csv`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        ElementPlus.ElMessage.success(
                            `${t('Export successful! Total exported')} ${exportData.length} ${t('records, from page')} ${startPage} ${t('to page')} ${endPage}`
                        );
                    } else {
                        ElementPlus.ElMessage.error(t('Export failed: server returned incorrect data format'));
                    }
                } catch (e) {
                    if (e.code === 'ECONNABORTED') {
                        ElementPlus.ElMessage.error(t('Export timeout, please reduce page range'));
                    } else {
                        ElementPlus.ElMessage.error(t('Export error') + ': ' + (e.response?.data?.detail || e.message));
                    }
                } finally {
                    exporting.value = false;
                    loading.value = false;
                }
            };

            const showDbInfo = async () => {
                try {
                    loading.value = true;
                    loadingProgress.value = t('Getting database information...');
                    const res = await axios.get(`${API_BASE.value}/db_info`, {
                        headers: {
                            'X-Secret': secret.value,
                            'X-Lang': currentLanguage.value
                        }
                    });

                    let message = `${t('Database Information')}Ôºö\n`;
                    message += `- ${t('Total rows')}: ${res.data.total_rows}\n`;
                    message += `- ${t('Number of indexes')}: ${res.data.indexes.length}\n`;
                    message += `- ${t('Number of fields')}: ${res.data.columns.length}\n\n`;

                    ElementPlus.ElMessageBox.alert(message, t('Database Information'), {
                        confirmButtonText: t('OK'),
                        customClass: 'db-info-alert',
                        showClose: false
                    });
                } catch (e) {
                    ElementPlus.ElMessage.error(t('Failed to get database information') + ': ' + (e.response?.data?.detail || e.message));
                } finally {
                    loading.value = false;
                }
            };

            // Ë∞ÉËØïÔºöÊ£ÄÊü•ÂΩìÂâçÊòæÁ§∫ÁöÑÊï∞ÊçÆ
            const debugCheckData = () => {
                console.group(t('Debug data'));
                console.log(t('Logs array length') + ':', logs.value.length);
                console.log('hasQueryResults:', hasQueryResults.value);
                console.log('showDistanceColumn:', showDistanceColumn.value);
                console.log('tableVersion:', tableVersion.value);
                console.log(t('Current query conditions') + ':', {
                    filterType: queryForm.filterType,
                    filterValue: queryForm.filterValue,
                    center_x: queryForm.center_x,
                    center_y: queryForm.center_y,
                    center_z: queryForm.center_z,
                    radius: queryForm.radius,
                    dimension: queryForm.dimension
                });

                if (logs.value.length > 0) {
                    // ÁªüËÆ°‰∏çÂêåÁ±ªÂûãÁöÑÊï∞ÊçÆ
                    const typeCount = {};
                    const idCount = {};

                    logs.value.forEach(record => {
                        const type = record.type || t('Unknown');
                        const id = record.id || t('Unknown');

                        typeCount[type] = (typeCount[type] || 0) + 1;
                        idCount[id] = (idCount[id] || 0) + 1;
                    });

                    console.log(t('Record type distribution') + ':', typeCount);
                    console.log(t('ID distribution') + ':', idCount);

                    // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏çÁ¨¶ÂêàÂΩìÂâçÊü•ËØ¢Êù°‰ª∂ÁöÑËÆ∞ÂΩï
                    if (queryForm.filterType && queryForm.filterValue) {
                        const invalidRecords = logs.value.filter(record => {
                            const fieldValue = record[queryForm.filterType];
                            return !fieldValue || !fieldValue.includes(queryForm.filterValue);
                        });

                        if (invalidRecords.length > 0) {
                            console.warn(`Found ${invalidRecords.length} records that do not match query conditions`);
                            console.warn('Invalid record example:', invalidRecords[0]);
                        } else {
                            console.log('All records match current query conditions');
                        }
                    }
                } else {
                    console.log(t('No data currently displayed'));
                }
                console.groupEnd();
            };

            onMounted(async () => {
                // È¶ñÂÖàÂä†ËΩΩÂèØÁî®ËØ≠Ë®Ä
                await loadAvailableLanguages();

                // ‰ºòÂåñÔºöÂè™Âú®ÊúâÂØÜÁ†ÅÊó∂ÊâçÂ∞ùËØïÁôªÂΩïÔºåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑËØ∑Ê±Ç
                if (secret.value && secret.value.trim()) {
                    await login();
                    await fetchStats();
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂØÜÁ†ÅÔºå‰πüÈáçÁΩÆÊü•ËØ¢Êù°‰ª∂
                    resetSearch();
                }

                // Ê∑ªÂä†Ë∞ÉËØïÊåâÈíÆÔºà‰ªÖÂºÄÂèëÁéØÂ¢ÉÔºâ
                if (isDebugMode.value) {
                    setTimeout(() => {
                        const debugBtn = document.createElement('button');
                        debugBtn.id = 'debug-btn';
                        debugBtn.textContent = t('Debug data');
                        debugBtn.addEventListener('click', debugCheckData);
                        document.body.appendChild(debugBtn);
                    }, 1000);
                }
            });

            return {
                isLoggedIn, secret, apiBase, stats, logs, queryForm, tempCoord, pagination,
                loading, tableLoading, loadingProgress, lastQueryTime, hasQueryResults,
                exportDialogVisible, exportOption, exportStartPage, exportEndPage, exporting,
                hasActiveCoordQuery, showDistanceColumn, isDebugMode,
                currentLanguage, availableLanguages, translations,
                t, // ÂØºÂá∫ÁøªËØëÂáΩÊï∞
                login, logout, fetchStats, fetchLogs, applyCoordQuery, clearCoordQuery,
                resetSearch, handlePageChange, handlePageSizeChange,
                showExportDialog, handleExportConfirm, showDbInfo, debugCheckData,
                getRowKey, tableKey, changeLanguage
            };
        }
    }).use(ElementPlus).mount("#app");
</script>
</body>
</html>